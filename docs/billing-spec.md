# 有料化（プリペイド容量チケット）仕様

## ドキュメント位置づけ（2026-02-17時点）
- 本ドキュメントは「廃止済み仕様（プリペイド方式）」。
- 現行仕様は `docs/billing-subscription-spec.md` を参照。

## 概要
- チーム（= ルーム）単位でデータ使用量を集計する
- 課金は「勝手に課金しない」前提のプリペイド方式
- ユーザーが購入するのは `GB・月`（見せ方）
- 内部の残高は `GiB-day`（1GiBを1日使える権利）で管理し、日次で消費する

## 無料枠
- チーム合計 `512MB`（= 512MiB）

## 使用量のカウント
- 画像アップロードの「元画像」に加えて、プレビュー/サムネ等の派生データも含めて全カウント
- 現状は `orig + preview` を加算している（バックエンドで S3 `HeadObject` の `ContentLength` を参照）

## チケット（販売）
SKU と価格（叩き台）
- `1gbm`: 1GB・月 / 1,000円
- `10gbm`: 10GB・月 / 8,000円（20%OFF）
- `50gbm`: 50GB・月 / 35,000円（約30%OFF）

購入フロー
- 管理者がStripe Checkoutで購入する（勝手に課金しない）
- Webhook（`/stripe/webhook`）で決済完了を確認して残高を付与する

Webhook Secret（`whsec_...`）の場所
- Stripe Dashboard → Developers → Webhooks → 対象エンドポイント → Signing secret の「Reveal」
- （テストモード/本番モードで別になるため注意）

換算ルール
- `1GB・月` を購入すると内部残高に `30 GiB-day` を加算する（固定 30 日換算）

## 消費ルール
- 日次（JST 0:00）で、当該時点の使用量に応じて残高を消費する
- 1日あたりの消費量: `使用中GiB × 1日`（= `使用中GiB-day`）

## 残高不足時の挙動
- `残高が0` かつ `使用量が無料枠以上` の場合:
  - 写真の新規アップロードのみ停止
  - 閲覧/コメント/削除は継続可
  - 削除などで使用量が無料枠未満に戻るとアップロードは再開

## 権限
ロール
- `admin`（管理者）: メンバー管理、使用量/購入、全投稿（写真/コメント）の編集削除、フォルダ削除
- `member`（メンバー）: 投稿、閲覧、コメント

運用ルール
- 管理者は「部屋（チーム）を作成したユーザー」に固定
- 入室したユーザーは自動でメンバーになる
- メンバーは管理者になれない（昇格機能なし）
- 1ユーザーが作れる部屋は1つまで
- 1ユーザーが所属できるお部屋は同時に1つまで（他のお部屋に所属中は入室不可。退出後に入室可）

部屋削除（全データ）
- 管理者（作成者）は部屋を削除できる
- 削除対象: フォルダ/写真/コメント/S3画像、課金情報（購入/日次消費/Stripeセッション等）、メンバー情報

フォルダ鍵
- フォルダごとにパスワード（任意）を設定できる
- 鍵付きフォルダの操作（写真一覧/アップロード/エクスポート/削除/鍵更新）には `x-folder-password` が必要

メンバー無効化
- 管理者はメンバーを `disabled` にできる
- `disabled` のメンバーは API を `403` で拒否する

## 監査ログ
主要アクションは `kind=audit` の JSON ログで記録する
- `billing.purchase`
- `billing.daily_sweep`
- `folder.delete`
- `photo.purge`
